<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Sản Phẩm - HOA SAC</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="header.css">
    <link rel="stylesheet" href="footer.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Great+Vibes&display=swap" rel="stylesheet">
    
    <style>
        /* CSS RIÊNG CHO TRANG CHI TIẾT */
        .pdp-container { display: flex; max-width: 1400px; margin: 0 auto; padding: 150px 5% 100px; gap: 60px; }
        .pdp-gallery { flex: 1.5; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .zoom-container { position: relative; overflow: hidden; cursor: crosshair; background-color: #f9f9f9; }
        .zoom-container img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.2s ease; transform-origin: center center; display: block; }
        .zoom-container.active img { transform: scale(2); }
        .zoom-container:first-child { grid-column: span 2; }
        .pdp-info { flex: 1; position: sticky; top: 120px; height: fit-content; }
        .breadcrumb { font-size: 12px; color: #999; text-transform: uppercase; margin-bottom: 20px; letter-spacing: 1px; }
        .pdp-title { font-size: 2.5rem; font-weight: 400; margin-bottom: 10px; line-height: 1.2; }
        .pdp-price { font-size: 1.5rem; font-weight: 500; margin-bottom: 30px; display: block; }
        .pdp-desc { font-size: 14px; color: #555; line-height: 1.8; margin-bottom: 40px; }
        .selector-group { margin-bottom: 30px; }
        .selector-label { display: block; font-size: 12px; text-transform: uppercase; font-weight: 600; margin-bottom: 10px; }
        .size-options { display: flex; gap: 10px; }
        .size-opt { width: 45px; height: 45px; border: 1px solid #ddd; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; }
        .size-opt:hover, .size-opt.selected { border-color: #000; background-color: #000; color: #fff; }
        .pdp-actions { display: flex; gap: 20px; margin-top: 40px; }
        .btn-add-bag { flex: 1; background-color: #000; color: #fff; border: none; padding: 18px; text-transform: uppercase; letter-spacing: 2px; font-weight: 600; cursor: pointer; transition: opacity 0.3s; }
        .btn-add-bag:hover { opacity: 0.8; }
        .btn-wishlist { width: 60px; border: 1px solid #ddd; background: #fff; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        .pdp-accordion { margin-top: 60px; border-top: 1px solid #eee; }
        .accordion-item { border-bottom: 1px solid #eee; }
        .accordion-header { padding: 20px 0; cursor: pointer; display: flex; justify-content: space-between; font-weight: 500; text-transform: uppercase; font-size: 13px; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; color: #666; font-size: 13px; line-height: 1.6; }
        .accordion-item.active .accordion-content { max-height: 200px; padding-bottom: 20px; }
        .related-section { padding: 100px 5%; border-top: 1px solid #eee; }
        .related-title { text-align: center; font-size: 2rem; margin-bottom: 60px; font-weight: 300; }
        @media (max-width: 900px) { .pdp-container { flex-direction: column; padding-top: 100px; } .pdp-gallery { grid-template-columns: 1fr; } .zoom-container:first-child { grid-column: auto; } .pdp-info { position: static; } }
    </style>

    <!-- SCRIPT: Định nghĩa hàm GLOBAL ngay tại đây để tránh lỗi -->
    <script>
        // Global Helpers
        window.zoom = function(e) {
            const container = e.currentTarget;
            const img = container.querySelector('img');
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left; 
            const y = e.clientY - rect.top;
            const xPercent = (x / rect.width) * 100;
            const yPercent = (y / rect.height) * 100;
            container.classList.add('active');
            img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
        }

        window.resetZoom = function(e) {
            const container = e.currentTarget;
            container.classList.remove('active');
            setTimeout(() => { if(container.querySelector('img')) container.querySelector('img').style.transformOrigin = 'center center'; }, 200);
        }

        window.toggleAccordion = function(header) {
            const item = header.parentElement;
            item.classList.toggle('active');
        }

        window.triggerAddToCart = function(productStr) {
            // Parse lại object từ chuỗi (do truyền qua HTML attribute) 
            let product;
            if (typeof productStr === 'string') {
                product = JSON.parse(productStr);
            } else {
                product = productStr;
            }

            const sizeBtn = document.querySelector('.size-opt.selected');
            const size = sizeBtn ? sizeBtn.innerText : 'M';
            
            // Lấy màu
            const colorBtn = document.querySelector('.color-opt.selected');
            let color = '#000000';
            if(colorBtn) color = colorBtn.style.backgroundColor || '#000000';

            const imgFolder = product.department === 'men' ? 'assets/images/products/men/' : 'assets/images/products/women/';
            
            const cartItem = {
                name: product.name,
                price: product.price,
                image: imgFolder + product.image,
                size: size,
                color: color
            };
            
            // Kiểm tra hàm global từ main.js
            if(window.addToCart) window.addToCart(cartItem);
            else alert("Đã thêm vào giỏ (Demo - main.js chưa load)");
        }
    </script>
</head>
<body>
    <div class="noise-overlay"></div>
    <div class="custom-cursor"></div>

    <header class="site-header">
        <div class="header-container">
            <a href="index.html" class="logo">HOA SAC.</a>
            <div class="hamburger-menu"><span class="bar"></span><span class="bar"></span><span class="bar"></span></div>
            <nav class="main-nav">
                <ul class="nav-list">
                    <li class="nav-item"><a href="men.html" class="nav-link">Nam</a></li>
                    <li class="nav-item"><a href="women.html" class="nav-link">Nữ</a></li>
                    <li class="nav-item"><a href="collections.html" class="nav-link">Bộ Sưu Tập</a></li>
                    <li class="nav-item"><a href="#" class="nav-link">Stories</a></li>
                    <li class="nav-item"><a href="contact.html" class="nav-link">Liên Hệ</a></li>
                    <li class="nav-item"><a href="about.html" class="nav-link">Về Hoa Sắc</a></li>
                </ul>
            </nav>
            <div class="header-actions"><a href="/cart" class="cart-btn">Giỏ hàng (0)</a></div>
        </div>
    </header>

    <main>
        <div class="pdp-container" id="product-detail-container">
            <p style="width:100%; text-align:center;">Đang tải thông tin sản phẩm...</p>
        </div>

        <section class="related-section" id="cross-sell-section" style="display: none; background-color: #fcfcfc;">
            <h2 class="related-title">Complete The Look</h2>
            <div class="catalog-grid" id="cross-sell-grid"></div>
        </section>

        <section class="related-section">
            <h2 class="related-title">You May Also Like</h2>
            <div class="catalog-grid" id="related-grid"></div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="footer-container"><div class="footer-col brand-col"><h3 class="footer-logo">HOA SAC.</h3></div></div>
        <div class="footer-bottom"><p>&copy; <span id="year"></span> HOA SAC Fashion.</p></div>
    </footer>

    <script src="https://unpkg.com/@studio-freight/lenis@1.0.42/dist/lenis.min.js"></script>
    <script src="main.js"></script>

    <script>
        // --- LOGIC RENDER & FETCH ---
        
        function renderProductDetail(product) {
            const container = document.getElementById('product-detail-container');
            const formattedPrice = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(product.price);
            
            const imgFolder = product.department === 'men' ? 'assets/images/products/men/' : 'assets/images/products/women/';
            const imgSrc = imgFolder + product.image;

            // JSON stringify object để truyền vào onclick, cần escape dấu nháy đơn
            const productJson = JSON.stringify(product).replace(/'/g, "\'");

            container.innerHTML = `
                <div class="pdp-gallery">
                    <div class="zoom-container" onmousemove="zoom(event)" onmouseleave="resetZoom(event)">
                        <img src="${imgSrc}" alt="${product.name}" onerror="this.src='assets/images/products/women/coat.jpg'">
                    </div>
                    <div class="zoom-container">
                        <img src="${imgSrc}" style="filter: brightness(0.95)">
                    </div>
                    <div class="zoom-container">
                        <img src="${imgSrc}" style="filter: contrast(1.1)">
                    </div>
                </div>

                <div class="pdp-info">
                    <div class="breadcrumb">Home / ${product.department} / ${product.category}</div>
                    <h1 class="pdp-title">${product.name}</h1>
                    <span class="pdp-price">${formattedPrice}</span>
                    
                    <p class="pdp-desc">
                        Sản phẩm được chế tác thủ công từ chất liệu cao cấp nhất. 
                        Thiết kế tinh giản tôn vinh vẻ đẹp tự nhiên. 
                        ${product.department === 'men' ? 'Form dáng chuẩn mực quý ông.' : 'Đường cắt mềm mại nữ tính.'}
                    </p>

                    <div class="selector-group">
                        <span class="selector-label">Màu Sắc</span>
                        <div class="color-options" style="display:flex; gap:10px; margin-bottom:20px;">
                            <div class="color-opt selected" style="width:30px; height:30px; border-radius:50%; background:#000; border:1px solid #ccc; cursor:pointer;"></div>
                            <div class="color-opt" style="width:30px; height:30px; border-radius:50%; background:#f0f0f0; border:1px solid #ccc; cursor:pointer;"></div>
                        </div>
                    </div>

                    <div class="selector-group">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span class="selector-label" style="margin:0;">Size</span>
                            <a href="#" id="size-guide-link" style="font-size:11px; text-decoration:underline; color:#666;">Hướng dẫn chọn size</a>
                        </div>
                        <div class="size-options">
                            ${product.department === 'men' 
                                ? `<div class="size-opt">48</div><div class="size-opt selected">50</div><div class="size-opt">52</div>`
                                : `<div class="size-opt">S</div><div class="size-opt selected">M</div><div class="size-opt">L</div>`
                            }
                        </div>
                    </div>

                    <div class="pdp-actions">
                        <button class="btn-add-bag" onclick='triggerAddToCart(${productJson})'>Thêm Vào Giỏ</button>
                        <button class="btn-wishlist">❤</button>
                    </div>

                    <div class="trust-badges" style="display:flex; gap:20px; margin-top:30px; padding-top:20px; border-top:1px solid #eee; font-size:11px; color:#555; text-transform:uppercase;">
                        <div style="display:flex; align-items:center; gap:5px;"><span>↺</span> Đổi trả 7 ngày</div>
                        <div style="display:flex; align-items:center; gap:5px;"><span>✈</span> Free Shipping</div>
                        <div style="display:flex; align-items:center; gap:5px;"><span>★</span> Chính hãng 100%</div>
                    </div>

                    <div class="pdp-accordion">
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">Chi tiết sản phẩm <span>+</span></div>
                            <div class="accordion-content">Chất liệu: 100% Lụa tơ tằm / Wool cao cấp.<br>Lót: Cupro thoáng khí.<br>Sản xuất tại Việt Nam.</div>
                        </div>
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(this)">Vận chuyển & Đổi trả <span>+</span></div>
                            <div class="accordion-content">Miễn phí vận chuyển toàn quốc.<br>Đổi trả trong vòng 7 ngày nếu lỗi sản xuất.</div>
                        </div>
                    </div>
                </div>
            `;
            
            setupEvents(product);
        }

        function setupEvents(product) {
            // Size Events
            document.querySelectorAll('.size-opt').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.size-opt').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Color Events
            document.querySelectorAll('.color-opt').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.color-opt').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Modal Size Guide
            const guideLink = document.getElementById('size-guide-link');
            const guideModal = document.getElementById('size-guide-modal');
            if(guideLink && guideModal) {
                guideLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    guideModal.classList.add('active');
                });
                const isMen = product.department === 'men';
                document.getElementById('tab-men').style.display = isMen ? 'block' : 'none';
                document.getElementById('tab-women').style.display = isMen ? 'none' : 'block';
            }
        }

        function renderCrossSell(allProducts, crossIds) {
            const section = document.getElementById('cross-sell-section');
            const grid = document.getElementById('cross-sell-grid');
            
            // Lọc danh sách cross-sell
            const items = allProducts.filter(p => crossIds.includes(p.id));
            
            if (items.length > 0) {
                section.style.display = 'block';
                grid.innerHTML = '';
                items.forEach(p => createProductCard(p, grid));
            } else {
                section.style.display = 'none'; // Ẩn nếu không có
            }
        }

        function renderRelated(allProducts, category, currentId) {
            const related = allProducts.filter(p => p.category === category && p.id !== currentId).slice(0, 4);
            const grid = document.getElementById('related-grid');
            grid.innerHTML = '';
            related.forEach(p => createProductCard(p, grid));
        }

        function createProductCard(p, container) {
            const imgFolder = p.department === 'men' ? 'assets/images/products/men/' : 'assets/images/products/women/';
            const div = document.createElement('div');
            div.className = 'product-item';
            // Sử dụng template giống trang danh mục
            div.innerHTML = `
                <div class="prod-img">
                    <a href="product-detail.html?id=${p.id}">
                        <img src="${imgFolder + p.image}" alt="${p.name}" onerror="this.src='assets/images/products/women/coat.jpg'">
                    </a>
                </div>
                <div class="prod-info">
                    <h3>${p.name}</h3>
                    <span class="price">$${p.price}</span>
                </div>
            `;
            container.appendChild(div);
        }

        // --- MAIN EXECUTION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            let productId = parseInt(urlParams.get('id'));

            const mockProduct = {
                id: 999, name: "Structured Wool Coat (Demo)", price: 890, 
                category: "outerwear", image: "coat.jpg", department: "women", cross_sell: []
            };

            try {
                // Sử dụng hàm getProductsDB từ main.js nếu có (hỗ trợ Admin data)
                let products = [];
                if (window.getProductsDB) {
                    products = await window.getProductsDB();
                } else {
                    const response = await fetch('assets/data/products.json');
                    products = await response.json();
                }

                if (!productId && products.length > 0) productId = products[0].id;

                const product = products.find(p => p.id === productId);

                if (product) {
                    renderProductDetail(product);
                    if (product.cross_sell) renderCrossSell(products, product.cross_sell);
                    else document.getElementById('cross-sell-section').style.display = 'none';
                    
                    renderRelated(products, product.category, product.id);
                } else {
                    document.getElementById('product-detail-container').innerHTML = '<p style="text-align:center">Không tìm thấy sản phẩm.</p>';
                }

            } catch (error) {
                console.warn("Chế độ Offline:", error);
                renderProductDetail(mockProduct);
            }
        });
    </script>

    <!-- SIZE GUIDE MODAL -->
    <div class="modal-overlay" id="size-guide-modal">
        <div class="modal-content" style="max-width: 800px; padding: 40px;">
            <span class="close-modal" onclick="document.getElementById('size-guide-modal').classList.remove('active')">&times;</span>
            <h3>Bảng Quy Đổi Kích Cỡ</h3>
            <div id="tab-women">
                <h4>Nữ (Women)</h4>
                <table style="width:100%; border-collapse: collapse; font-size:13px;">
                    <tr style="border-bottom:1px solid #ddd;"><th style="padding:10px;">Size</th><th>Ngực (cm)</th><th>Eo (cm)</th><th>Mông (cm)</th></tr>
                    <tr><td style="padding:10px;">S</td><td>82-86</td><td>64-68</td><td>88-92</td></tr>
                    <tr><td style="padding:10px;">M</td><td>87-91</td><td>69-73</td><td>93-97</td></tr>
                    <tr><td style="padding:10px;">L</td><td>92-96</td><td>74-78</td><td>98-102</td></tr>
                </table>
            </div>
            <div id="tab-men" style="display:none;">
                <h4>Nam (Men)</h4>
                <table style="width:100%; border-collapse: collapse; font-size:13px;">
                    <tr style="border-bottom:1px solid #ddd;"><th style="padding:10px;">Size</th><th>Vai (cm)</th><th>Ngực (cm)</th><th>Dài Áo (cm)</th></tr>
                    <tr><td style="padding:10px;">48 (S)</td><td>44</td><td>96</td><td>72</td></tr>
                    <tr><td style="padding:10px;">50 (M)</td><td>46</td><td>100</td><td>74</td></tr>
                    <tr><td style="padding:10px;">52 (L)</td><td>48</td><td>104</td><td>76</td></tr>
                </table>
            </div>
        </div>
    </div>
</body>
</html>